#!/usr/bin/env node
// Decode a Symbol transfer transaction payload (network/main/test agnostic).
// Usage: node symbol_tx_decode.js '<payload-hex>'
// If no argument is given, a sample payload is decoded.

const samplePayload =
  "B500000000000000BCF3A51C0FE0B9E805BA8C29F5F2354726ECACDDF9A5D9866D4FE13FE5454458D9A3D821FE4FBC06C4A70ED7B58467107D1FA6B9E2687F53636E89F68105DB016AC9FEE77ABF835DD24061FFD02FBBB69D4E2B19ED779E82D1D3B34234F7B0EE00000000016854416020980000000000087162E022000000681B455247DD2B2F9B7E5F41A4BC7861C7D8A445BD2C17DB0500010000000000F82302A23F91ED6B00000000000000000074657374";

function toBuf(hex) {
  if (!/^([0-9a-fA-F]{2})+$/.test(hex)) throw new Error("payload must be hex");
  return Buffer.from(hex, "hex");
}

function readUint64LE(buf, offset) {
  return buf.readBigUInt64LE(offset);
}

function decode(payloadHex) {
  const buf = toBuf(payloadHex);
  const size = buf.readUInt32LE(0);
  const signature = buf.slice(4, 4 + 64).toString("hex").toUpperCase();
  const signerPublicKey = buf.slice(68, 68 + 32).toString("hex").toUpperCase();
  const version = buf.readUInt8(104);
  const networkType = buf.readUInt8(105);
  const type = buf.readUInt16LE(106);
  const maxFee = readUint64LE(buf, 108);
  const deadline = readUint64LE(buf, 116);
  const recipient = buf.slice(124, 148).toString("hex").toUpperCase();
  const messageSize = buf.readUInt16LE(148);
  const mosaicsCount = buf.readUInt8(150);
  // skip transferTransactionBodyReserved_1 (1 byte)
  let offset = 152;

  const mosaics = [];
  for (let i = 0; i < mosaicsCount; i += 1) {
    const id = readUint64LE(buf, offset);
    const amount = readUint64LE(buf, offset + 8);
    mosaics.push({ id: "0x" + id.toString(16), amount: amount.toString() });
    offset += 16;
  }

  const message = buf.slice(offset, offset + messageSize).toString("utf8");

  return {
    size,
    signature,
    signerPublicKey,
    version,
    networkType,
    type,
    maxFee: maxFee.toString(),
    deadline: deadline.toString(),
    recipient,
    mosaicsCount,
    mosaics,
    messageSize,
    message,
  };
}

function main() {
  const hex = process.argv[2] || samplePayload;
  try {
    const tx = decode(hex);
    console.dir(tx, { depth: null });
  } catch (err) {
    console.error("Decode error:", err.message);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}
